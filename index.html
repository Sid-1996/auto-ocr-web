<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å…¨è‡ªå‹•åœ–ç‰‡æ–‡å­—è­˜åˆ¥å·¥å…·</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', 'Microsoft JhengHei', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
            min-height: 100vh;
            padding: 20px;
            position: relative;
        }
        
        .container {
            width: 100%;
            max-width: 900px;
            background: white;
            border-radius: 16px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            overflow: hidden;
            margin: 0 auto;
        }
        
        header {
            background: #4e54c8;
            color: white;
            padding: 20px;
            text-align: center;
        }
        
        h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }
        
        .description {
            font-size: 16px;
            opacity: 0.9;
        }
        
        .main-content {
            padding: 30px;
            display: flex;
            flex-direction: column;
            gap: 25px;
        }
        
        .upload-area {
            border: 3px dashed #4e54c8;
            border-radius: 12px;
            padding: 40px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: #f8f9ff;
            min-height: 300px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        
        .upload-area:hover, .upload-area.dragover {
            background: #eef0ff;
            border-color: #ff6b6b;
        }
        
        .upload-area i {
            font-size: 64px;
            color: #4e54c8;
            margin-bottom: 20px;
        }
        
        .upload-area h3 {
            font-size: 24px;
            color: #4e54c8;
            margin-bottom: 15px;
        }
        
        .upload-area p {
            color: #666;
            margin: 8px 0;
            font-size: 16px;
        }
        
        .file-input {
            display: none;
        }
        
        .upload-btn {
            background: #4e54c8;
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            margin: 15px 0;
            transition: all 0.3s;
        }
        
        .upload-btn:hover {
            background: #3a3eb3;
        }
        
        .language-selector {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        
        .lang-btn {
            padding: 8px 15px;
            border: 2px solid #4e54c8;
            border-radius: 20px;
            background: white;
            color: #4e54c8;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
        }
        
        .lang-btn.active {
            background: #4e54c8;
            color: white;
        }
        
        .processing-area {
            display: none;
            flex-direction: column;
            align-items: center;
            gap: 20px;
            text-align: center;
        }
        
        .spinner {
            width: 60px;
            height: 60px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid #4e54c8;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .progress-text {
            font-size: 18px;
            color: #4e54c8;
            font-weight: 600;
        }
        
        .result-area {
            display: none;
            flex-direction: column;
            gap: 20px;
        }
        
        .result-title {
            font-size: 20px;
            color: #333;
            font-weight: 600;
            text-align: center;
        }
        
        .text-output {
            background: #f8f9ff;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            min-height: 200px;
            max-height: 400px;
            overflow-y: auto;
            font-size: 16px;
            line-height: 1.6;
            color: #333;
            white-space: pre-wrap;
            user-select: all; /* è®“æ–‡å­—æ›´å®¹æ˜“é¸æ“‡ */
            cursor: text;
            transition: all 0.3s ease;
        }
        
        .text-output:hover {
            border-color: #4e54c8;
            box-shadow: 0 0 0 2px rgba(78, 84, 200, 0.1);
        }
        
        .text-output:focus {
            outline: none;
            border-color: #4e54c8;
            box-shadow: 0 0 0 3px rgba(78, 84, 200, 0.2);
        }
        
        .action-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .btn {
            background: #4e54c8;
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 50px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .btn:hover {
            background: #3a3eb3;
            transform: translateY(-2px);
        }
        
        .btn:active {
            transform: translateY(0);
        }
        
        .btn-new {
            background: #00b894;
        }
        
        .btn-new:hover {
            background: #009e7d;
        }
        
        .hint {
            font-size: 14px;
            color: #666;
            text-align: center;
            margin-top: 15px;
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            background: #00b894;
            color: white;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            transform: translateX(100%);
            opacity: 0;
            transition: all 0.3s ease;
            z-index: 1000;
            max-width: 300px;
        }
        
        .notification.show {
            transform: translateX(0);
            opacity: 1;
        }
        
        .status-bar {
            width: 100%;
            height: 6px;
            background: #f0f0f0;
            border-radius: 3px;
            overflow: hidden;
            margin-top: 10px;
        }
        
        .status-progress {
            height: 100%;
            background: linear-gradient(90deg, #4e54c8, #8f94fb);
            width: 0%;
            transition: width 0.3s ease;
        }
        
        .debug-info {
            font-size: 12px;
            color: #888;
            margin-top: 10px;
            display: block;
            text-align: left;
            background: #f5f5f5;
            padding: 10px;
            border-radius: 5px;
            max-height: 100px;
            overflow-y: auto;
        }
        
        footer {
            text-align: center;
            padding: 20px;
            color: #666;
            font-size: 14px;
            border-top: 1px solid #eee;
        }
        
        @media (max-width: 600px) {
            .container {
                border-radius: 12px;
            }
            
            h1 {
                font-size: 24px;
            }
            
            .main-content {
                padding: 20px;
            }
            
            .upload-area {
                padding: 30px 15px;
            }
            
            .action-buttons {
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
            }
            
            .notification {
                top: 10px;
                right: 10px;
                left: 10px;
                text-align: center;
            }
            
            .language-selector {
                flex-wrap: wrap;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>âš¡ è¶…å¿«é€Ÿåœ–ç‰‡æ–‡å­—è­˜åˆ¥å·¥å…·</h1>
            <p class="description">æŒ‰ Ctrl+V è²¼ä¸Šæˆªåœ– â†’ è‡ªå‹•è­˜åˆ¥ â†’ ç«‹å³è¤‡è£½æ–‡å­— âš¡</p>
        </header>
        
        <div class="main-content">
            <div class="upload-area" id="uploadArea">
                <i>âš¡</i>
                <h3>è¶…å¿«é€Ÿåœ–ç‰‡æ–‡å­—è­˜åˆ¥</h3>
                <p><strong>ğŸš€ æœ€å¿«æ–¹å¼ï¼šç›´æ¥æŒ‰ Ctrl+V è²¼ä¸Šæˆªåœ–</strong></p>
                <p>æˆ–æ‹–æ”¾åœ–ç‰‡åˆ°æ­¤å€åŸŸ</p>
                <p>æˆ–é»æ“Šä¸‹æ–¹æŒ‰éˆ•é¸æ“‡æª”æ¡ˆ</p>
                
                <input type="file" class="file-input" id="fileInput" accept="image/*">
                <button class="upload-btn" id="uploadBtn">é¸æ“‡åœ–ç‰‡æª”æ¡ˆ</button>
                
                <div class="language-selector">
                    <div class="lang-btn active" data-lang="eng">è‹±æ–‡</div>
                    <div class="lang-btn" data-lang="chi_sim">ä¸­æ–‡</div>
                </div>
                
                <p class="hint">ğŸ’¡ æç¤ºï¼šè­˜åˆ¥å®Œæˆå¾Œæ–‡å­—æœƒè‡ªå‹•è¤‡è£½ä¸¦é¸å–ï¼Œå¯ç›´æ¥ç·¨è¼¯</p>
                <p class="hint">æ”¯æ´æ ¼å¼: JPG, PNG, GIF, BMP | å»ºè­°ä½¿ç”¨æ¸…æ™°çš„å°åˆ·é«”åœ–ç‰‡</p>
                <div class="debug-info" id="debugInfo">ç³»çµ±æº–å‚™ä¸­...</div>
            </div>
            
            <div class="processing-area" id="processingArea">
                <div class="spinner"></div>
                <div class="progress-text" id="progressText">æ­£åœ¨è™•ç†åœ–ç‰‡ä¸¦æå–æ–‡å­—...</div>
                <div class="status-bar">
                    <div class="status-progress" id="statusProgress"></div>
                </div>
            </div>
            
            <div class="result-area" id="resultArea">
                <h3 class="result-title">âœ… è­˜åˆ¥æˆåŠŸï¼æ–‡å­—å·²è‡ªå‹•è¤‡è£½</h3>
                <div class="text-output" id="textOutput" contenteditable="true" spellcheck="false"></div>
                <div class="action-buttons">
                    <button class="btn" id="copyBtn">
                        <span>ğŸ“‹ é‡æ–°è¤‡è£½æ–‡å­—</span>
                    </button>
                    <button class="btn btn-new" id="newImageBtn">
                        <span>ğŸ”„ è™•ç†æ–°åœ–ç‰‡</span>
                    </button>
                </div>
                <p class="hint">ğŸ’¡ ä½ å¯ä»¥ç›´æ¥åœ¨ä¸Šæ–¹æ–‡å­—æ¡†ä¸­ç·¨è¼¯æ–‡å­—ï¼Œç„¶å¾Œé‡æ–°è¤‡è£½</p>
            </div>
        </div>
        
        <footer>
            <p>Â© å…¨è‡ªå‹•åœ–ç‰‡æ–‡å­—è­˜åˆ¥å·¥å…· | ä½¿ç”¨ Tesseract.js é–‹æºæŠ€è¡“</p>
            <p style="font-size: 12px; color: #999; margin-top: 5px;">æœ¬å·¥å…·åŸºæ–¼å…è²»é–‹æºæŠ€è¡“ï¼Œä¸­æ–‡è­˜åˆ¥ç²¾æº–åº¦å¯èƒ½ä¸å¦‚å•†æ¥­ä»˜è²»æœå‹™</p>
            <p style="font-size: 12px; color: #666; margin-top: 10px; border-top: 1px solid #eee; padding-top: 10px;">
                åŸå§‹ç¢¼ä¾†æºï¼š<a href="https://github.com/Sid-1996/Auto-OCR-Web" target="_blank" rel="noopener" style="color:#1976d2;text-decoration:underline;">GitHub - Sid-1996/Auto-OCR-Web</a>
            </p>
        </footer>
    </div>

    <div class="notification" id="notification">
        æ–‡å­—å·²è‡ªå‹•è¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼
    </div>

    <!-- ä½¿ç”¨æœ€æ–°ç©©å®šç‰ˆæœ¬çš„ Tesseract.js -->
    <script src="https://unpkg.com/tesseract.js@v4.1.1/dist/tesseract.min.js"></script>
    
    <script>
        let worker = null;
        let selectedLanguage = 'eng';
        let extractedText = '';
        let isWorkerReady = false;
        
        // DOM å…ƒç´ 
        const uploadArea = document.getElementById('uploadArea');
        const processingArea = document.getElementById('processingArea');
        const resultArea = document.getElementById('resultArea');
        const textOutput = document.getElementById('textOutput');
        const newImageBtn = document.getElementById('newImageBtn');
        const copyBtn = document.getElementById('copyBtn');
        const uploadBtn = document.getElementById('uploadBtn');
        const fileInput = document.getElementById('fileInput');
        const notification = document.getElementById('notification');
        const progressText = document.getElementById('progressText');
        const statusProgress = document.getElementById('statusProgress');
        const langButtons = document.querySelectorAll('.lang-btn');
        const debugInfo = document.getElementById('debugInfo');
        
        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            log('é é¢è¼‰å…¥å®Œæˆï¼Œé–‹å§‹åˆå§‹åŒ–...');
            initializeApp();
            setupEventListeners();
        });
        
        function log(message) {
            console.log(message);
            debugInfo.innerHTML += `<div>${new Date().toLocaleTimeString()}: ${message}</div>`;
            debugInfo.scrollTop = debugInfo.scrollHeight;
        }
        
        async function initializeApp() {
            try {
                log('æ­£åœ¨åˆå§‹åŒ– Tesseract.js...');
                
                // å‰µå»º workerï¼Œå„ªåŒ–é…ç½®
                worker = await Tesseract.createWorker({
                    logger: m => {
                        if (m.status) {
                            log(`ç‹€æ…‹: ${m.status} - ${Math.round(m.progress * 100)}%`);
                            updateProgress(m);
                        }
                    },
                    // å„ªåŒ–è¨­å®š
                    cachePath: './',
                    gzip: true
                });
                
                log('Worker å‰µå»ºæˆåŠŸï¼Œæ­£åœ¨è¼‰å…¥èªè¨€åŒ…...');
                
                // åŒæ™‚è¼‰å…¥è‹±æ–‡å’Œä¸­æ–‡èªè¨€åŒ…ä»¥æé«˜é€Ÿåº¦
                await worker.loadLanguage('eng+chi_sim');
                await worker.initialize('eng+chi_sim');
                
                // è¨­å®š OCR åƒæ•¸ä»¥æé«˜ç²¾åº¦å’Œé€Ÿåº¦
                await worker.setParameters({
                    tessedit_pageseg_mode: Tesseract.PSM.AUTO,
                    tessedit_ocr_engine_mode: Tesseract.OEM.LSTM_ONLY,
                    tessedit_char_blacklist: '|`~!@#$%^&*()_+-=[]{}\\;\':",./<>?', // éæ¿¾å¸¸è¦‹èª¤è­˜åˆ¥å­—ç¬¦
                });
                
                log('åˆå§‹åŒ–å®Œæˆï¼ç³»çµ±æº–å‚™å°±ç·’ã€‚');
                isWorkerReady = true;
                showNotification('ğŸš€ ç³»çµ±å·²å°±ç·’ï¼Œç›´æ¥æŒ‰ Ctrl+V è²¼ä¸Šåœ–ç‰‡å³å¯ï¼');
                
            } catch (error) {
                log(`åˆå§‹åŒ–å¤±æ•—: ${error.message}`);
                showNotification('åˆå§‹åŒ–å¤±æ•—ï¼Œå˜—è©¦é‡æ–°è¼‰å…¥...', true);
                
                // é™ç´šè™•ç†ï¼šåªè¼‰å…¥è‹±æ–‡
                try {
                    await worker.loadLanguage('eng');
                    await worker.initialize('eng');
                    isWorkerReady = true;
                    showNotification('ç³»çµ±æº–å‚™å®Œæˆï¼ˆè‹±æ–‡æ¨¡å¼ï¼‰');
                } catch (fallbackError) {
                    console.error('Initialization error:', fallbackError);
                    showNotification('åˆå§‹åŒ–å¤±æ•—ï¼Œè«‹é‡æ–°æ•´ç†é é¢', true);
                }
            }
        }
        
        function setupEventListeners() {
            // æª”æ¡ˆé¸æ“‡
            uploadBtn.addEventListener('click', () => fileInput.click());
            fileInput.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    handleFile(e.target.files[0]);
                }
            });
            
            // é»æ“Šä¸Šå‚³å€åŸŸ
            uploadArea.addEventListener('click', (e) => {
                if (!e.target.closest('.lang-btn') && !e.target.closest('.upload-btn')) {
                    fileInput.click();
                }
            });
            
            // æ‹–æ”¾
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                uploadArea.addEventListener(eventName, preventDefaults, false);
            });
            
            ['dragenter', 'dragover'].forEach(eventName => {
                uploadArea.addEventListener(eventName, highlight, false);
            });
            
            ['dragleave', 'drop'].forEach(eventName => {
                uploadArea.addEventListener(eventName, unhighlight, false);
            });
            
            uploadArea.addEventListener('drop', handleDrop, false);
            
            // è²¼ä¸Š
            document.addEventListener('paste', handlePaste);
            
            // èªè¨€é¸æ“‡
            langButtons.forEach(btn => {
                btn.addEventListener('click', handleLanguageChange);
            });
            
            // æŒ‰éˆ•
            newImageBtn.addEventListener('click', resetUI);
            copyBtn.addEventListener('click', () => {
                const currentText = textOutput.textContent || textOutput.innerText;
                if (currentText) {
                    copyToClipboard(currentText);
                }
            });
            
            // æ–‡å­—è¼¸å‡ºå€åŸŸçš„å³æ™‚è¤‡è£½åŠŸèƒ½
            textOutput.addEventListener('input', () => {
                window.extractedText = textOutput.textContent || textOutput.innerText;
            });
            
            // å¿«é€Ÿéµæ”¯æ´
            document.addEventListener('keydown', (e) => {
                // Ctrl+Enter å¿«é€Ÿè¤‡è£½
                if (e.ctrlKey && e.key === 'Enter') {
                    e.preventDefault();
                    const currentText = textOutput.textContent || textOutput.innerText || window.extractedText;
                    if (currentText) {
                        copyToClipboard(currentText);
                    }
                }
                // Escape é‡è¨­ç•Œé¢
                if (e.key === 'Escape') {
                    e.preventDefault();
                    resetUI();
                }
            });
        }
        
        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }
        
        function highlight() {
            uploadArea.classList.add('dragover');
        }
        
        function unhighlight() {
            uploadArea.classList.remove('dragover');
        }
        
        function handleDrop(e) {
            const dt = e.dataTransfer;
            const files = dt.files;
            if (files.length > 0) {
                handleFile(files[0]);
            }
        }
        
        function handlePaste(e) {
            log('æª¢æ¸¬åˆ°è²¼ä¸Šæ“ä½œ');
            
            const clipboardData = e.clipboardData || window.clipboardData;
            if (!clipboardData) {
                log('ç„¡æ³•å­˜å–å‰ªè²¼ç°¿');
                return;
            }
            
            // æª¢æŸ¥æª”æ¡ˆ
            if (clipboardData.files && clipboardData.files.length > 0) {
                const file = clipboardData.files[0];
                log(`å¾å‰ªè²¼ç°¿å–å¾—æª”æ¡ˆ: ${file.name}, é¡å‹: ${file.type}`);
                if (file.type.startsWith('image/')) {
                    e.preventDefault();
                    handleFileWithPreprocessing(file);
                    return;
                }
            }
            
            // æª¢æŸ¥ items
            if (clipboardData.items) {
                for (let i = 0; i < clipboardData.items.length; i++) {
                    const item = clipboardData.items[i];
                    if (item.type.startsWith('image/')) {
                        log(`å¾å‰ªè²¼ç°¿å–å¾—åœ–ç‰‡é …ç›®: ${item.type}`);
                        const blob = item.getAsFile();
                        if (blob) {
                            e.preventDefault();
                            handleFileWithPreprocessing(blob);
                            return;
                        }
                    }
                }
            }
            
            log('å‰ªè²¼ç°¿ä¸­æ²’æœ‰æ‰¾åˆ°åœ–ç‰‡');
            showNotification('ğŸ’¡ è«‹ä½¿ç”¨æˆªåœ–å·¥å…·è¤‡è£½åœ–ç‰‡åˆ°å‰ªè²¼ç°¿ï¼Œç„¶å¾ŒæŒ‰ Ctrl+V', true);
        }
        
        async function handleLanguageChange(e) {
            const newLang = e.target.getAttribute('data-lang');
            
            langButtons.forEach(b => b.classList.remove('active'));
            e.target.classList.add('active');
            
            selectedLanguage = newLang;
            log(`åˆ‡æ›èªè¨€åˆ°: ${selectedLanguage}`);
            
            // å¦‚æœåˆ‡æ›åˆ°ä¸­æ–‡ï¼Œéœ€è¦é‡æ–°è¼‰å…¥èªè¨€åŒ…
            if (newLang.includes('chi') && worker) {
                try {
                    showNotification(`æ­£åœ¨è¼‰å…¥ ${e.target.textContent} èªè¨€åŒ…...`);
                    log(`é–‹å§‹è¼‰å…¥ ${newLang} èªè¨€åŒ…...`);
                    
                    await worker.loadLanguage(newLang);
                    await worker.initialize(newLang);
                    
                    log(`${newLang} èªè¨€åŒ…è¼‰å…¥æˆåŠŸ`);
                    showNotification(`${e.target.textContent} èªè¨€åŒ…è¼‰å…¥å®Œæˆï¼`);
                } catch (error) {
                    log(`èªè¨€åŒ…è¼‰å…¥å¤±æ•—: ${error.message}`);
                    showNotification(`${e.target.textContent} èªè¨€åŒ…è¼‰å…¥å¤±æ•—`, true);
                }
            } else {
                showNotification(`å·²åˆ‡æ›åˆ° ${e.target.textContent} æ¨¡å¼`);
            }
        }
        
        function handleFile(file) {
            if (!file.type.startsWith('image/')) {
                showNotification('è«‹é¸æ“‡åœ–ç‰‡æª”æ¡ˆï¼', true);
                return;
            }
            
            log(`é–‹å§‹è™•ç†æª”æ¡ˆ: ${file.name} (${(file.size/1024).toFixed(1)}KB)`);
            handleFileWithPreprocessing(file);
        }
        
        // æ–°å¢åœ–ç‰‡é è™•ç†åŠŸèƒ½
        async function handleFileWithPreprocessing(file) {
            try {
                // åˆ‡æ›åˆ°è™•ç†ç•Œé¢
                uploadArea.style.display = 'none';
                processingArea.style.display = 'flex';
                resultArea.style.display = 'none';
                
                progressText.textContent = 'æ­£åœ¨å„ªåŒ–åœ–ç‰‡...';
                statusProgress.style.width = '10%';
                
                // åœ–ç‰‡é è™•ç†
                const processedFile = await preprocessImage(file);
                log('åœ–ç‰‡é è™•ç†å®Œæˆï¼Œé–‹å§‹è­˜åˆ¥...');
                
                processImage(processedFile);
            } catch (error) {
                log(`é è™•ç†å¤±æ•—: ${error.message}`);
                // å¦‚æœé è™•ç†å¤±æ•—ï¼Œä½¿ç”¨åŸå§‹åœ–ç‰‡
                processImage(file);
            }
        }
        
        // åœ–ç‰‡é è™•ç†å‡½æ•¸ - æé«˜è­˜åˆ¥ç²¾åº¦
        function preprocessImage(file) {
            return new Promise((resolve) => {
                const img = new Image();
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                
                img.onload = () => {
                    // è¨ˆç®—æœ€ä½³å°ºå¯¸ï¼ˆç¢ºä¿ä¸æœƒå¤ªå°å½±éŸ¿è­˜åˆ¥ï¼‰
                    let { width, height } = img;
                    const maxSize = 2000;
                    const minSize = 800;
                    
                    if (width > maxSize || height > maxSize) {
                        const ratio = Math.min(maxSize / width, maxSize / height);
                        width = Math.round(width * ratio);
                        height = Math.round(height * ratio);
                    } else if (width < minSize && height < minSize) {
                        const ratio = Math.max(minSize / width, minSize / height);
                        width = Math.round(width * ratio);
                        height = Math.round(height * ratio);
                    }
                    
                    canvas.width = width;
                    canvas.height = height;
                    
                    // ç™½è‰²èƒŒæ™¯
                    ctx.fillStyle = 'white';
                    ctx.fillRect(0, 0, width, height);
                    
                    // å¢å¼·å°æ¯”åº¦å’Œæ¸…æ™°åº¦
                    ctx.filter = 'contrast(130%) brightness(105%) saturate(0%)';
                    ctx.drawImage(img, 0, 0, width, height);
                    
                    // è½‰æ›ç‚ºé«˜è³ªé‡ PNG
                    canvas.toBlob(resolve, 'image/png', 1.0);
                };
                
                img.onerror = () => resolve(file); // å¦‚æœè™•ç†å¤±æ•—ï¼Œè¿”å›åŸæª”æ¡ˆ
                img.src = URL.createObjectURL(file);
            });
        }
        
        async function processImage(file) {
            try {
                statusProgress.style.width = '20%';
                
                // æ™ºèƒ½èªè¨€æª¢æ¸¬å’Œå„ªåŒ–è¨­å®š
                const isLikelyChinese = selectedLanguage.includes('chi');
                const ocrLanguage = isLikelyChinese ? 'eng+chi_sim' : 'eng';
                
                log(`é–‹å§‹è­˜åˆ¥æ–‡å­—ï¼Œä½¿ç”¨èªè¨€: ${ocrLanguage}`);
                progressText.textContent = 'æ­£åœ¨è­˜åˆ¥åœ–ç‰‡ä¸­çš„æ–‡å­—...';
                
                // å„ªåŒ–çš„ OCR è¨­å®š
                const ocrOptions = {
                    tessedit_pageseg_mode: Tesseract.PSM.AUTO,
                    tessedit_ocr_engine_mode: Tesseract.OEM.LSTM_ONLY,
                };
                
                // é‡å°ä¸­æ–‡çš„ç‰¹æ®Šå„ªåŒ–
                if (isLikelyChinese) {
                    ocrOptions.tessedit_pageseg_mode = Tesseract.PSM.SINGLE_BLOCK;
                    log('ä½¿ç”¨ä¸­æ–‡å„ªåŒ–è¨­å®š');
                }
                
                // é€²è¡Œ OCR è­˜åˆ¥
                const result = await worker.recognize(file, ocrLanguage, ocrOptions);
                
                log(`è­˜åˆ¥å®Œæˆï¼Œä¿¡å¿ƒåº¦: ${result.data.confidence.toFixed(2)}%`);
                
                // æ–‡å­—å¾Œè™•ç†å’Œæ¸…ç†
                let extractedText = result.data.text ? result.data.text.trim() : '';
                extractedText = cleanupText(extractedText);
                
                if (extractedText && extractedText.length > 3) {
                    log(`æˆåŠŸè­˜åˆ¥åˆ° ${extractedText.length} å€‹å­—å…ƒ`);
                    window.extractedText = extractedText;
                    textOutput.textContent = extractedText;
                    
                    // ç«‹å³è¤‡è£½åˆ°å‰ªè²¼ç°¿
                    await copyToClipboard(extractedText);
                    
                    // é¡¯ç¤ºçµæœ
                    processingArea.style.display = 'none';
                    resultArea.style.display = 'flex';
                    
                    // è‡ªå‹•èšç„¦åˆ°æ–‡å­—å€åŸŸä»¥ä¾¿å¿«é€Ÿç·¨è¼¯
                    setTimeout(() => {
                        textOutput.focus();
                        if (window.getSelection) {
                            const range = document.createRange();
                            range.selectNodeContents(textOutput);
                            const sel = window.getSelection();
                            sel.removeAllRanges();
                            sel.addRange(range);
                        }
                    }, 100);
                    
                } else {
                    throw new Error('ç„¡æ³•è­˜åˆ¥åˆ°æœ‰æ•ˆæ–‡å­—å…§å®¹');
                }
                
            } catch (error) {
                log(`è™•ç†å¤±æ•—: ${error.message}`);
                console.error('OCR error:', error);
                
                const errorMsg = `è­˜åˆ¥å¤±æ•— ğŸ˜\n\nğŸ’¡ æç¤ºï¼š\nâ€¢ ç¢ºä¿åœ–ç‰‡æ¸…æ™°ä¸”æ–‡å­—å°æ¯”åº¦é«˜\nâ€¢ å˜—è©¦æˆªåœ–æˆ–é‡æ–°æ‹ç…§\nâ€¢ é¿å…å‚¾æ–œæˆ–æ¨¡ç³Šçš„æ–‡å­—\nâ€¢ ä½¿ç”¨å°åˆ·é«”æ•ˆæœæ›´ä½³\n\néŒ¯èª¤è©³æƒ…ï¼š${error.message}`;
                
                window.extractedText = errorMsg;
                textOutput.textContent = errorMsg;
                
                processingArea.style.display = 'none';
                resultArea.style.display = 'flex';
                
                showNotification('è­˜åˆ¥å¤±æ•—ï¼Œè«‹å˜—è©¦æ›´æ¸…æ™°çš„åœ–ç‰‡', true);
            }
        }
        
        // æ–‡å­—æ¸…ç†å’Œå„ªåŒ–å‡½æ•¸
        function cleanupText(text) {
            if (!text) return '';
            
            return text
                // ç§»é™¤å¤šé¤˜çš„ç©ºç™½å­—ç¬¦
                .replace(/\s+/g, ' ')
                // ç§»é™¤è¡Œé¦–è¡Œå°¾ç©ºæ ¼
                .replace(/^\s+|\s+$/gm, '')
                // ç§»é™¤å¤šé¤˜çš„æ›è¡Œ
                .replace(/\n\s*\n/g, '\n')
                // ç§»é™¤å¸¸è¦‹çš„ OCR éŒ¯èª¤å­—ç¬¦
                .replace(/[|`~]/g, '')
                .trim();
        }
        
        function updateProgress(message) {
            if (message.status === 'recognizing text') {
                progressText.textContent = `æ­£åœ¨è­˜åˆ¥æ–‡å­—... ${Math.round(message.progress * 100)}%`;
                statusProgress.style.width = `${message.progress * 100}%`;
            } else if (message.status === 'loading tesseract core') {
                progressText.textContent = 'è¼‰å…¥è­˜åˆ¥æ ¸å¿ƒ...';
                statusProgress.style.width = '20%';
            } else if (message.status === 'initializing tesseract') {
                progressText.textContent = 'åˆå§‹åŒ–è­˜åˆ¥å¼•æ“...';
                statusProgress.style.width = '40%';
            } else if (message.status === 'loading language traineddata') {
                progressText.textContent = 'è¼‰å…¥èªè¨€è³‡æ–™...';
                statusProgress.style.width = '60%';
            } else if (message.status === 'initializing api') {
                progressText.textContent = 'åˆå§‹åŒ– API...';
                statusProgress.style.width = '80%';
            }
        }
        
        async function copyToClipboard(text) {
            try {
                if (navigator.clipboard && window.isSecureContext) {
                    await navigator.clipboard.writeText(text);
                    showNotification('ğŸ“‹ æ–‡å­—å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼');
                } else {
                    // å‚™ç”¨æ–¹æ³•
                    const textArea = document.createElement('textarea');
                    textArea.value = text;
                    textArea.style.position = 'fixed';
                    textArea.style.left = '-999999px';
                    textArea.style.top = '-999999px';
                    document.body.appendChild(textArea);
                    textArea.focus();
                    textArea.select();
                    
                    const successful = document.execCommand('copy');
                    document.body.removeChild(textArea);
                    
                    if (successful) {
                        showNotification('ğŸ“‹ æ–‡å­—å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼');
                    } else {
                        throw new Error('Copy command failed');
                    }
                }
            } catch (err) {
                log(`è¤‡è£½å¤±æ•—: ${err.message}`);
                showNotification('è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•é¸æ“‡ä¸¦è¤‡è£½ (Ctrl+A, Ctrl+C)', true);
                
                // è‡ªå‹•é¸æ“‡æ–‡å­—ä½œç‚ºå‚™ç”¨æ–¹æ¡ˆ
                if (textOutput && window.getSelection) {
                    const range = document.createRange();
                    range.selectNodeContents(textOutput);
                    const sel = window.getSelection();
                    sel.removeAllRanges();
                    sel.addRange(range);
                }
            }
        }
        
        function showNotification(message, isError = false) {
            notification.textContent = message;
            notification.style.background = isError ? '#ff6b6b' : '#00b894';
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, isError ? 5000 : 3000);
        }
        
        function resetUI() {
            uploadArea.style.display = 'flex';
            processingArea.style.display = 'none';
            resultArea.style.display = 'none';
            textOutput.textContent = '';
            extractedText = '';
            statusProgress.style.width = '0%';
            fileInput.value = '';
            log('ç•Œé¢å·²é‡è¨­ï¼Œæº–å‚™è™•ç†æ–°åœ–ç‰‡');
        }
    </script>
</body>
</html>
